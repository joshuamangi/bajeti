{% extends "base.html" %}
{% block content %}
{# #pDetailCards { display: none; }#}

{# Security question warning (auto-dismiss after 20s) #}
{% if user.security_answer is none or user.security_answer == '' %}
<div class="p-alert-warning" role="alert" id="securityWarning" class="p-security-alert">
  <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
  <strong style="margin-left:.5rem">Important:</strong>
  <span style="margin-left:.5rem">Please set your <em>Security Question</em> from your Profile (☰ → Account → Profile) to help protect your account and enable password recovery.</span>
  <button id="closeSecurityWarning" class="p-security-btn">×</button>
</div>
{% endif %}

{# Generic error alert (server-provided) #}
{% if error %}
<div class="p-alert-error" role="alert" class="p-security-alert-error">
  <i class="fa fa-exclamation-circle"></i>
  <span style="margin-left:.5rem">{{ error }}</span>
</div>
{% endif %}

<!-- Title + toggles -->
<div class="p-title-card">
  <h1>{{ current_month }}'s Budget</h1>
  <div class="p-welcome-visibility">
    <div>
      <p class="p-welcome-text">Welcome, {{ user.first_name }} {{ user.last_name }}</p>
    </div>
    <div  class="p-visibility">
      <button id="toggleVisibility" class="p-actions-btns p-actions-btns-primary" title="Hide/Show sensitive values"><i id="eyeIcon" class="fa fa-eye"></i></button>
    </div>
  </div>
</div>

<div id="pSnackBar">
</div>

<!-- Summary & Add Category -->
<section>
  {% set total_limit = categories_with_stats | sum(attribute='limit_amount') %}
  {% set total_balance = categories_with_stats | sum(attribute='balance') %}
  {% set total_used = total_limit - total_balance %}
  {% set progress_percent = (total_used / total_limit * 100) if total_limit > 0 else 0 %}
  
  <!-- <div class="p-summary-progress-bar">
    <div class="p-summary-progress-fill" 
          style="width: {{ progress_percent }}%;">
    </div>
  </div>-->

  <div class="p-summary-card">
    <div class="p-summary-cards">
      <div onclick="generateModal('pBudgetModal','pBudgetClose','')">
        <p>Monthly Budget</p>
        {% if budget_details and budget_details.amount %}
          <h3 class="p-summary-value sensitive">{{budget_details.amount | commafy(2)}}</h3>
        {% else %}
          <h3 class="p-summary-value">0.00</h3>
        {% endif %}
      </div>
    </div>
    <div class="p-summary-cards">
        <p>Total Balance</p>
        <h3 class="p-summary-value sensitive {% if categories_with_stats | sum(attribute='balance') < 0 %} p-negative {% endif %}" data-value="{{ categories_with_stats | sum(attribute='balance') | commafy(2)}}">
            {{ categories_with_stats | sum(attribute='balance') | commafy(2) }}
        </h3>
    </div>
  </div>
</section>
<section>
  <div class="p-add-category">
      <button class="p-button-info" id="launchAddCategory" onclick="generateModal('pCategoryModal','pCategoryClose','closeCategoryModalBtn')">+ Add New Category</button>
  </div>
</section>

<!-- Category Progress section -->
<section>
  <p class="p-category-progress-paragraph"> Categories</p>
  <div class="p-category-progress-list">
    
    {% for c in categories_with_stats %}
      {% set used = c.used %}
      {% set limit = c.limit_amount %}
      {% set balance = c.balance %}
      {% set exceeded = balance < 0 %}
      {% set percent = (used / limit * 100) if limit > 0 else 0 %}
      {% set display_percent = percent if percent <= 100 else 100 %}
      <div class="p-category-item" onclick="generateModal('categoryDetailModal{{ c.id }}','pCategoryDetailClose{{ c.id }}','')">
          <div class="p-category-header">
            <span class="p-category-name">{{ c.name }}</span>
            {% if balance == 0 %}
                <span class="sensitive p-category-status zero">
                    No balance
                </span>
            {% elif exceeded %}
                <span class="sensitive p-category-status exceeded">
                    {{ (balance * -1) | commafy(0) }} over
                </span>
            {% else %}
                <span class="sensitive p-category-status ok">
                    {{ balance | commafy(0) }} left
                </span>
            {% endif %}
          </div>

          <!-- Progress bar container -->
          <div class="p-progress-wrapper">
            <div class="p-progress-bar">
                <div class="p-progress-fill
                    {% if balance == 0 %}
                        p-zero-fill
                    {% elif exceeded %}
                        p-exceeded-fill
                    {% else %}
                        p-ok-fill
                    {% endif %}"
                    style="width: {{ display_percent }}%;">
                </div>
            </div>

            <span class="p-progress-percent
                {% if percent > 100 %}p-percent-exceeded{% endif %}">
                {{ percent | round(1) }}%
            </span>
          </div>

      </div>
    {% endfor %}

  </div>
</section>

<!-- DESKTOP: table view -->
<div id="tableView" class="table-responsive">
  <table id="categoriesTable" class="p-table" style="width:100%; border-collapse:collapse;">
    <thead>
      <tr style="text-align:left; border-bottom:1px solid var(--border);">
        <th style="padding:.6rem">Category</th>
        <th style="padding:.6rem">Limit</th>
        <th style="padding:.6rem">Expenses</th>
        <th style="padding:.6rem">Balance</th>
        <th style="padding:.6rem">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for cat in categories_with_stats %}
      <tr style="border-bottom:1px dashed var(--border);">
        <td style="padding:.6rem; font-weight:500;" data-label="Category">{{ cat.name }}</td>
        <td style="padding:.6rem;" data-label="Limit"><span class="sensitive" data-value="{{ cat.limit_amount }}">{{ cat.limit_amount }}</span></td>
        <td style="padding:.6rem;" data-label="Expenses">
          <a href="#" class="p-expense-amount {% if cat.expense_count == 0 %} p-empty-exp {% endif %}" onclick="generateModal('expensesModal{{ cat.id }}','expensesClose{{ cat.id }}','')">
            {{ cat.expense_count }}
          </a>
        </td>
        <td style="padding:.6rem;" data-label="Balance">
          <span class="sensitive {% if cat.balance < 0 %} p-negative {% endif %}" data-value="{{ cat.balance }}">
            {% if cat.balance < 0 %} Over by {{ -cat.balance }} {% else %} Remaining {{ cat.balance }} {% endif %}
          </span>
        </td>
        <td style="padding:.6rem;" data-label="Actions">
          <div style="display:flex; gap:.4rem; flex-wrap:wrap;">
            <form method="POST" action="/dashboard/expenses" onsubmit="return confirmSubmit(this, 'Add Quick expense of {{ cat.limit_amount }} to {{ cat.name }}?')">
              <input type="hidden" name="category_id" value="{{ cat.id }}">
              <input type="hidden" name="amount" value="{{ cat.limit_amount }}">
              <input type="hidden" name="description" value="Quick Expense">
              <input type="hidden" name="month" value="{{ now }}">
              <button class="p-actions-btns p-actions-btns-primary" type="submit" title="Quick Expense"><i class="fa fa-bolt"></i></button>
            </form>

            <button class="p-actions-btns p-actions-btns-primary" title="Add Expense" onclick="generateModal('addExpenseModal{{ cat.id }}','addExpenseClose{{ cat.id }}','')"><i class="fa fa-plus"></i></button>

            <button class="p-actions-btns p-actions-btns-primary" title="Edit Category" onclick="generateModal('editCategoryModal{{ cat.id }}','editCategoryClose{{ cat.id }}','')"><i class="fa fa-pencil"></i></button>

            <form method="POST" action="/dashboard/categories/{{ cat.id }}/delete" onsubmit="return confirmSubmit(this, 'Delete category {{ cat.name }}?')">
              <button class="p-actions-btns p-actions-btns-primary" type="submit" title="Delete Category"><i class="fa fa-trash"></i></button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Budget Modal -->
 <!-- This modal should only be closed by the fa-close button. Creating a category should not close this modal and closing the allocations edit should not close this modal -->
 <!-- Budget Modal -->
{% if budget_allocations %} 
<div class="p-modal" id="pBudgetModal">
  <div class="p-modal-content">
    <a href="#" id="pBudgetClose" class="p-close">
      <i class="fa fa-close"></i>
    </a>
    <div class="p-modal-gap">
      <!-- Budget Header Section -->
      <div class="p-modal-divider">
        <div class="p-category-header">
          <span style="align-self: center;">
            <h3 class="p-modal-limit-name">{{ budget_allocations.budget.name }} Budget</h3>
          </span>
          
          <!-- Calculate allocation percentage (like used/limit in your example) -->
          {% set allocation_percent = (budget_allocations.summary.total_allocated / budget_allocations.budget.amount * 100) if budget_allocations.budget.amount > 0 else 0 %}
          {% set allocation_exceeded = allocation_percent > 100 %}
          {% set display_percent = allocation_percent if allocation_percent <= 100 else 100 %}
          
          <!-- Calculate unallocated percentage (unallocated/allocated * 100) -->
          {% set unallocated_percent = (budget_allocations.summary.unallocated / budget_allocations.summary.total_allocated * 100) if budget_allocations.summary.total_allocated > 0 else 0 %}      
          <div style="display: flex; gap: 0.4em;">
            <span style="align-items: center;">
              <div onclick="generateModal('pBudgetEditModal{{ budget_details.id }}','pEditBudgetClose{{ budget_details.id }}','')"
              style="cursor: pointer; box-shadow: var(--shadow); padding: 0.2em 0.4em 0.2em 0em;
               background: var(--bg-light); border-radius: 0.4em; display: flex; gap: 0.2em;">
                <p style="flex: 1;" class="p-category-limit-amount sensitive" 
                   data-value="{{ budget_allocations.budget.amount | commafy(0) }}">
                  {{ budget_allocations.budget.amount | commafy(0) }}
                </p>
                <i style="margin-left: 0.8em; font-size: 0.8em; align-self: center; color: var(--warning);" class="fa fa-pencil"></i>
              </div>
            </span>
          </div>
        </div>
        
        <!-- Progress Bar for ALLOCATION (like in your working example) -->
        <div style="margin-bottom: 0.2em;" class="p-progress-bar">
          <div class="p-progress-fill {% if allocation_exceeded %}p-exceeded-fill{% else %}p-ok-fill{% endif %}"
               style="width: {{ display_percent }}%;">
          </div>
        </div>
        <div style="font-size: 0.8em;">
          {% if allocation_exceeded %}
             <span class="p-category-status exceeded">
               {{ (allocation_percent - 100) | round(1) }}% over
             </span>
           {% else %}
             <span class="p-category-status ok">
               {{ allocation_percent | round(1) }}% allocated
             </span>
           {% endif %}   
        </div>
        </div>
      </div>
      
      <!-- Unallocated Amount Section -->
      <div class="p-category-progress-transfer-divider">
        <div class="p-modal-unallocated-container">
          <p style="font-weight: 600;">
            {% if budget_allocations.summary.unallocated < 0 %}
              Over Allocated by:
            {% else %}
              Unallocated:
            {% endif %}
          </p>
          <h4 class="sensitive {% if budget_allocations.summary.unallocated <= 0 %}p-negative{% else %}p-positive{% endif %}" 
              data-value="{{ budget_allocations.summary.unallocated | commafy(2) }}">
            {% if budget_allocations.summary.unallocated < 0 %}
              {{ (-budget_allocations.summary.unallocated) | commafy(2) }}
            {% else %}
              {{ budget_allocations.summary.unallocated | commafy(2) }}
            {% endif %}
          </h4>
        </div>
      </div>
      
      <!-- The rest of your code remains unchanged -->
      <!-- Categories Section -->
      <!-- Categories Section - Compact -->
      <div>
        <div class="p-category-progress-transfer-divider">
          <h4 style="font-size: 0.9em; color: var(--text); margin: 0 0 0.3em 0;">Categories</h4>
        </div>   
        <div>    
          <form action="/dashboard/categories" method="POST">
            <div style="display: grid; grid-template-columns: 1fr 1fr 28px; gap: 0.5em; align-items: center;">
              <input style="
                width: 100%; 
                height: 28px;
                padding: 0 0.6em;
                box-sizing: border-box;
                font-family: var(--ff);
                font-size: 0.8rem;
                color: var(--text);
                background: var(--bg-light);
                border: 1px solid var(--border-muted);
                border-radius: 4px;
                outline: none;
                transition: border-color 0.15s ease;
              " 
              name="name" 
              type="text" 
              placeholder="Name" 
              maxlength="16" 
              required>
              
              <input style="
                width: 100%; 
                height: 28px;
                padding: 0 0.6em;
                box-sizing: border-box;
                font-family: var(--ff);
                font-size: 0.8rem;
                color: var(--text);
                background: var(--bg-light);
                border: 1px solid var(--border-muted);
                border-radius: 4px;
                outline: none;
                transition: border-color 0.15s ease;
              " 
              name="limit_amount" 
              type="number" 
              placeholder="Amount" 
              required>
              
              <button style="
                width: 28px;
                height: 28px;
                padding: 0;
                background: var(--primary);
                color: var(--bg);
                border: none;
                border-radius: 4px;
                font-size: 0.8rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: opacity 0.15s ease;
              " 
              type="submit"
              title="Add Category">
                <i class="fa fa-add"></i>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Allocations Section - Compact -->
      <div style="margin-top: 0.8em;">
        <div class="p-category-progress-transfer-divider">
          <h4 style="font-size: 0.9em; color: var(--text); margin: 0 0 0.3em 0;">Allocations</h4>
        </div>
        <div>
          <form action="/dashboard/allocations" method="POST">
            <div style="display: grid; grid-template-columns: 1fr 1fr 28px; gap: 0.5em; align-items: center;">
              {% set allocated_category_ids = budget_allocations.allocations | map(attribute='category_id') | list %}
              {% set allocated_category_ids = (budget_allocations.allocations | default([])) | map(attribute='category_id') | list %}

              <input type="hidden" name="budget_id" value="{{ budget_allocations.budget.id }}">
              
              <select style="
                width: 100%; 
                height: 28px;
                padding: 0 0.6em;
                box-sizing: border-box;
                font-family: var(--ff);
                font-size: 0.8rem;
                color: var(--text);
                background: var(--bg-light);
                border: 1px solid var(--border-muted);
                border-radius: 4px;
                outline: none;
                cursor: pointer;
                appearance: none;
              " 
              name="category_id" 
              required>
                <option value="" style="color: var(--text-muted);">Select Category</option>
                {% for c in categories_with_stats %}
                  {% if c.id not in allocated_category_ids %}
                    <option value="{{ c.id }}" style="color: var(--text);">{{ c.name }}</option>
                  {% endif %}
                {% endfor %}
              </select>
              
              <input style="
                width: 100%; 
                height: 28px;
                padding: 0 0.6em;
                box-sizing: border-box;
                font-family: var(--ff);
                font-size: 0.8rem;
                color: var(--text);
                background: var(--bg-light);
                border: 1px solid var(--border-muted);
                border-radius: 4px;
                outline: none;
              " 
              type="number" 
              name="allocated_amount" 
              placeholder="Amount" 
              required>
              
              <button style="
                width: 28px;
                height: 28px;
                padding: 0;
                background: var(--primary);
                color: var(--bg);
                border: none;
                border-radius: 4px;
                font-size: 0.8rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: opacity 0.15s ease;
              " 
              type="submit"
              title="Add Allocation">
                <i class="fa fa-add"></i>
              </button>
            </div>
          </form>
        </div>
      </div>
          <!-- Allocation list will go here -->
          <div style="padding: 0.2em 0em 0em 0.4em; margin-top: 0.6em;">
          {% if budget_allocations.allocations %}
            <div style="display: grid; grid-template-columns: 1.5fr 1fr auto; gap: 0.4em; padding: 0.2em 1em 0.4em 0.6em;
                        border-bottom: 1px solid var(--bg-light); font-size: 0.9em; font-weight: 600; color: var(--highlight);">
              <div>Category Name</div>
              <div>Amount</div>
              <div>Actions</div>
            </div>
            <div style="padding: 0.4em; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-muted); border-radius: 6px;">
              <ul class="p-category-progress-ul" style="margin-top: 0; padding: 0;">
                {% for ba in budget_allocations.allocations | sort(attribute='category_name') %}
                  <li class="p-category-progress-li" style="
                    display: grid;
                    grid-template-columns: 1.5fr 1fr auto;
                    gap: 0.4em;
                    align-items: center;
                    padding: 0.8em 0.6em;
                    border-bottom: 1px solid var(--bg-light);
                    margin: 0;
                  ">
                    <!-- Category Name -->
                    <div style="
                      font-weight: 500;
                      overflow: hidden;
                      text-overflow: ellipsis;
                      white-space: nowrap;
                    ">
                      {{ ba.category_name }}
                    </div>
                    
                    <!-- Amount - Right aligned -->
                    <div style="
                      font-weight: 600;
                      text-align: center;
                      color: var(--success);
                    ">
                      {{ ba.allocated_amount | commafy(0) }}
                    </div>
                    
                    <!-- Actions -->
                    <div style="
                      display: flex;
                      gap: 0.5em;
                      justify-content: flex-end;
                      flex-shrink: 0;
                    ">
                      <button class="p-icon-btn-warning" 
                              onclick="generateModal('pEditAllocationModal{{ ba.category_id }}','pEditAllocationClose{{ ba.category_id }}','')">
                        <i class="fa fa-pencil"></i>
                      </button>
                      <form method="POST" 
                            action="/dashboard/allocations/{{ budget_details.id }}/delete/{{ ba.allocation_id }}" 
                            onsubmit="return confirmSubmit(this,'Delete allocation?')"
                            style="margin: 0;">
                        <button class="p-icon-btn-danger" type="submit">
                          <i class="fa fa-trash"></i>
                        </button>
                      </form>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% else %}
            <div class="p-category-progress-no-content" style="padding: 1.5em; text-align: center;">
              <strong class="p-no-expense" style="color: #6b7280;">
                No allocations created. Create Category or Create Allocation to create allocations.
              </strong>
            </div>
          {% endif %}
        </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% else %}
  <div class="p-modal" id="pBudgetModal" style="display: none;">
    <div class="p-modal-content">
      <p>No budget data available</p>
    </div>
  </div>
{% endif %}

<!-- Add Category modal -->
<div class="p-modal" id="pCategoryModal">
  <div class="p-modal-content">
    <form class="p-category-form" method="POST" action="/dashboard/categories">
      <a href="#" id="pCategoryClose" class="p-close"><i class="fa fa-close"></i></a>
      <h2 class="p-modal-limit-name">New Category</h2>
      <div class="p-modal-details">
        <div class="p-modal-form-content">
          <label for="name">Name</label>
          <input name="name" type="text" placeholder="Category Name (16 characters)" maxlength="16" required>
          <label for="limit_amount">Limit</label>
          <input name="limit_amount" type="number" placeholder="Category Limit" required>
        </div>
        <button type="submit" class="p-modal-btn" id="closeCategoryModalBtn">Add Category</button>
      </div>
    </form>
  </div>
</div>

<!-- Category Modal -->
{% for cat in categories_with_stats %}
  {% set used = cat.used %}
  {% set limit = cat.limit_amount %}
  {% set balance = cat.balance %}
  {% set percent = (used / limit * 100) if limit > 0 else 0 %}
  {% set exceeded = percent > 100 %}
  {% set display_percent = percent if percent <= 100 else 100 %}
  <div class="p-modal" id="categoryDetailModal{{ cat.id }}">
    <div class="p-modal-content">
      <a href="#" id="pCategoryDetailClose{{ cat.id }}" class="p-close"><i class="fa fa-close"></i></a>
      <div class="p-modal-gap">
        <div class="p-modal-divider p-category-header">
          <span> <h3 class="p-modal-limit-name">{{cat.name}}</h3> </span>
          {% if exceeded %}
            <span style="align-self:center;" class="p-category-status exceeded">
                {{ (percent - 100) | round(1) }}% over
            </span>
          {% else %}
            <span style="align-self:center;" class="p-category-status ok">
                {{ percent | round(1) }}% used
            </span>
          {% endif %}
           <span style="align-self:center;">
            <p class="p-category-limit-amount sensitive" data-value="{{ cat.limit_amount | commafy(0) }}">{{ cat.limit_amount | commafy(0) }}</p>
           </span>
        </div>
          <div class="p-category-progress-balance-container">
            <p style="font-weight: 600;">{% if cat.balance < 0 %} Over by: {% else %}Remaining: {% endif %}</p>
            <h4 class="sensitive {% if cat.balance <= 0 %} p-negative {% else %} p-positive {% endif %}" data-value="{{ cat.balance | commafy(2) }}">
              {% if cat.balance < 0 %}{{ (-cat.balance) | commafy(2) }}{% else %}{{ cat.balance | commafy(2) }}{% endif %}
            </h4>
          </div>
        <div style="margin-bottom: 0.8em;" class="p-progress-bar">
          <div class="p-progress-fill {% if exceeded %}p-exceeded-fill{% else %}p-ok-fill{% endif %}"
              style="width: {{ display_percent }}%;">
          </div>
        </div>
        <!-- Transfers -->
        <div class="p-category-progress-transfer-divider">
          <h4 style="font-size: 0.9em; padding-bottom: 0.4em;">Transfers</h4>
        </div>
        <div class="p-category-transfers-list">
          {% if cat.transfers_in or cat.transfers_out %}
          <div style="padding: 0.4em; max-height: 100px; overflow-y: auto; border: 1px solid var(--border-muted); border-radius: 6px; margin-bottom: 0.4em;">
            <ul class="p-category-progress-ul">
              {% for t in cat.transfers_in %}
              <li class="p-category-progress-li">
                <div style="align-self: center;">
                  <strong style="color: var(--success);">+{{ t.amount }}</strong> 
                  <small>from {{ t.from_category_name }}</small>
                  <small style="color:var(--text-muted)"> ({{ t.month }})</small>
                </div>
                <div style="display:flex; gap:.8rem;">
                  <form method="POST" action="/dashboard/transfers/{{t.id}}/undo" onsubmit="return confirmSubmit(this, 'Undo Transfer?')">
                    <button class="p-icon-btn-tertiary" type="submit"><i class="fa fa-undo"></i>
                </div>
              </li>
              {% endfor %}
              {% for t in cat.transfers_out %}
              <li class="p-category-progress-li">
                <div style="align-self: center;">
                  <strong style="color: var(--danger);">-{{ t.amount }}</strong>
                  <small> to {{ t.to_category_name }} </small>
                  <small style="color:var(--text-muted)"> ({{ t.month }})</small>
                </div>
                <div style="display:flex; gap:.8rem;">
                  <form method="POST" action="/dashboard/transfers/{{t.id}}/undo" onsubmit="return confirmSubmit(this, 'Undo Transfer?')">
                    <button class="p-icon-btn-tertiary" type="submit"><i class="fa fa-undo"></i>
                </div>
              </li>
              {% endfor %}
            </ul>
          </div>
          {% else %}
            <div class="p-category-progress-no-content">
              <strong class="p-no-expense">No transfer/topup this month.</strong>
            </div>
          {% endif %}
        </div>
        <!-- TODO: Add is this a mandatory expense --> 
         <!-- Expenses -->
        <div class="p-category-progress-expense-divider">
          <h4 style="font-size: 0.9em;">Expenses</h4>
        </div>
        <div class="p-category-progress-expenses">   
          <div style="flex:1;">
            <form method="POST" action="/dashboard/expenses"
              onsubmit="return confirmSubmit(this, 'Add Quick expense of {{ cat.limit_amount }} to {{ cat.name }}?')">
              <input type="hidden" name="category_id" value="{{ cat.id }}">
              <input type="hidden" name="amount" value="{{ cat.limit_amount }}">
              <input type="hidden" name="description" value="Quick Expense">
              <input type="hidden" name="month" value="{{ now }}">
              <button class="p-modal-btn-tertiary" type="submit" title="Quick Expense">
                Quick Expense
              </button>
            </form>
          </div>
          <div style="flex:1;">
              <button class="p-modal-btn-primary" title="Add Expense"
              onclick="generateModal('addExpenseModal{{ cat.id }}','addExpenseClose{{ cat.id }}','')">
              Add Expense
            </button>
            </div>
          </div>
          <div style="margin-top: 0.6em; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-muted); border-radius: 6px; padding: 0.4em;">
            {% if cat.expenses %}
              <ul class="p-category-progress-ul">
                {% for e in cat.expenses %}
                <li class="p-category-progress-li ">
                  <div style="align-self: center;">
                    <strong>{{ e.amount }}</strong> — <small>{{ e.description or "(no desc)" }}</small>
                    <small style="color:var(--text-muted)"> ({{ e.month }})</small>
                  </div>
                  <div style="display:flex; gap:.8rem;">
                    <button class="p-icon-btn-warning" onclick="generateModal('editExpenseModal{{ e.id }}','editExpenseClose{{ e.id }}','')"><i class="fa fa-pencil"></i></button>
                    <form method="POST" action="/dashboard/expenses/{{ e.id }}/delete" onsubmit="return confirmSubmit(this,'Delete expense?')">
                      <button class="p-icon-btn-danger" type="submit"><i class="fa fa-trash"></i></button>
                    </form>
                  </div>
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="p-category-progress-no-content">
                <strong class="p-no-expense">No expenses this month. Click the Quick Expense or Add Expense button to add an expense</strong>
              </div>
            {% endif %}
          </div>
        </div>
        <div class="p-category-progress-btns-container"> 
          <div style="flex:1;">
            <button class="p-modal-btn-primary" onclick="generateModal('transferModal{{ cat.id }}','transferClose{{ cat.id }}','')">
            Top Up Category
          </button>

          </div>  
          <div style="flex:1;">
            <button class="p-modal-btn-warning" title="Edit Category"
                    onclick="generateModal('editCategoryModal{{ cat.id }}','editCategoryClose{{ cat.id }}','')">
              Edit Category
            </button>
          </div>
          <div style="flex:1;">
            <form method="POST" action="/dashboard/categories/{{ cat.id }}/delete"
                  onsubmit="return confirmSubmit(this, 'Delete category {{ cat.name }}?')">
              <button class="p-modal-btn-danger" type="submit" title="Delete">
                Delete Category
              </button>
            </form>
          </div>
        </div>
      </div>  
    </div>
  </div>
{% endfor %}

<!-- Per-category modals -->
{% for cat in categories_with_stats %}
  <!-- Expenses list modal -->
  <div class="p-modal" id="expensesModal{{ cat.id }}">
    <div class="p-modal-content">
      <a href="#" id="expensesClose{{ cat.id }}" class="p-close"><i class="fa fa-close"></i></a>
      <h2 style="text-align: center;">Expenses — {{ cat.name }}</h2>
      <div class="p-modal-body">
        {% if cat.expenses %}
          <ul style="list-style:none;padding:1.2em;margin:0;">
            {% for e in cat.expenses %}
            <li style="padding:.5rem 0; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; gap:1rem;">
              <div>
                <strong>{{ e.amount }}</strong> — {{ e.description or "(no desc)" }}
                <small style="color:var(--text-muted)"> ({{ e.month }})</small>
              </div>
              <div style="display:flex; gap:.8rem;">
                <button class="p-btn-warning" onclick="generateModal('editExpenseModal{{ e.id }}','editExpenseClose{{ e.id }}','')">Edit</button>
                <form method="POST" action="/dashboard/expenses/{{ e.id }}/delete" onsubmit="return confirmSubmit(this,'Delete expense?')">
                  <button class="p-btn-danger" type="submit">Delete</button>
                </form>
              </div>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="p-no-expense">No expenses for this month. Click the ➕ or ⚡️ button to add expenses</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Add Expense modal -->
  <div class="p-modal" id="addExpenseModal{{ cat.id }}">
    <div class="p-modal-content">
      <form class="p-category-form" method="POST" action="/dashboard/expenses">
        <a href="#" id="addExpenseClose{{ cat.id }}" class="p-close"><i class="fa fa-close"></i></a>
        <p style="font-size: 1.1em;" class="p-modal-limit-name">Add Expense to {{ cat.name }}</p>
        <div class="p-modal-details">
          <div class="p-modal-form-content">
            <input type="hidden" name="category_id" value="{{ cat.id }}">
            <label>Amount</label>
            <input name="amount" type="number" placeholder="Enter Expense Amount" required>
            <label>Description</label>
            <input name="description" type="text" placeholder="Optional">
            <label>Month</label>
            <input name="month" type="text" placeholder="YYYY-MM" value="{{ now }}" readonly>
          </div>
          <button type="submit" class="p-modal-btn" id="closeAddExpenseBtn{{ cat.id }}">Add Expense</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Category modal -->
  <div class="p-modal" id="editCategoryModal{{ cat.id }}">
    <div class="p-modal-content">
      <form class="p-category-form" method="POST" action="/dashboard/categories/{{ cat.id }}/edit">
        <a href="#" id="editCategoryClose{{ cat.id }}" class="p-close"><i class="fa fa-close"></i></a>
        <h2 class="p-modal-limit-name">Edit Category</h2>
        <div class="p-modal-details">
          <div class="p-modal-form-content">
            <label>Name</label>
            <input type="text" name="name" value="{{ cat.name }}" maxlength="16" required>
            <label>Limit</label>
            <input name="limit_amount" type="number" value="{{ cat.limit_amount }}" required>
          </div>
          <button type="submit" class="p-modal-btn" id="closeEditCategoryBtn{{ cat.id }}">Save</button>
        </div>
      </form>
    </div>
  </div>

  {# Edit each expense of this category #}
  {% for e in cat.expenses %}
  <div class="p-modal" id="editExpenseModal{{ e.id }}">
    <div class="p-modal-content">
      <form class="p-category-form" method="POST" action="/dashboard/expenses/{{ e.id }}/edit">
        <a href="#" id="editExpenseClose{{ e.id }}" class="p-close"><i class="fa fa-close"></i></a>
        <h2 class="p-modal-limit-name">Edit Expense</h2>
        <div class="p-modal-details">
          <div class="p-modal-form-content">
            <label>Amount</label>
            <input name="amount" type="number" value="{{ e.amount }}" required>
            <label>Description</label>
            <input name="description" type="text" placeholder="Optional" value="{{ e.description }}">
            <label>Month</label>
            <input name="month" type="text" value="{{ e.month }}" readonly>
            <label>Category</label>
            <select style="border: 1px solid var(--text-muted);" name="category_id" required>
              {% for c in categories_with_stats %}
              <option value="{{ c.id }}" {% if c.id == e.category_id %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="p-modal-btn" id="closeEditExpenseBtn{{ e.id }}">Save</button>
        </div>
      </form>
    </div>
  </div>
  {% endfor %}

<!-- Transfer Modal -->
  <div class="p-modal" id="transferModal{{ cat.id }}">
    <div class="p-modal-content">
      <form class="p-category-form" method="POST" action="/dashboard/transfers">
        <a href="#" id="transferClose{{ cat.id }}" class="p-close"><i class="fa fa-close"></i></a>
        <p style="font-size: 1.1em;" class="p-modal-limit-name">Top Up {{ cat.name }}</p>
        <div class="p-modal-details">
          <div class="p-modal-form-content">
            <input type="hidden" name="to_category_id" value="{{ cat.id }}">
            <label>From Category</label>
            <select style="border: 1px solid var(--text-muted);" name="from_category_id" required>
              <option value="">Select</option>
              {% for c in categories_with_stats if c.id != cat.id and c.balance > 0 %}
              <option value="{{ c.id }}">{{ c.name }} (Remaining: {{ c.balance | commafy(2) }})</option>
              {% endfor %}
            </select>
            <label>Amount</label>
            <input name="amount" type="number" step="0.01" placeholder="Enter Amount" required>
            <label>Description (optional)</label>
            <input name="description" placeholder="Optional" type="text">
            <label>Month</label>
            <input name="month" type="text" value="{{ now }}" readonly>
          </div>
          <button type="submit" class="p-modal-btn">Make Transfer</button>
        </div>
      </form>
    </div>
  </div>
{% endfor %}

<!-- Edit Budget Modal-->
{% set budget_id=budget_details.id%}
<div class="p-modal" id="pBudgetEditModal{{ budget_id }}">
  <div class="p-modal-content">
    <form class="p-category-form" method="POST" action="/dashboard/budgets/{{ budget_id }}/edit">
      <a href="#" id="pEditBudgetClose{{ budget_id}}" class="p-close"><i class="fa fa-close"></i></a>
      <h2 class="p-modal-limit-name">Edit Budget</h2>
      <div class="p-modal-details">
        <div class="p-modal-form-content">
          <label>Budget Name</label>
          <input type="text" name="budget_name" value="{{ budget_details.name }}" readonly>
          <label>Budget Amount</label>
          <input type="number" name="budget_amount" value="{{ budget_details.amount }}" required>
          <button type="submit" class="p-modal-btn" id="pCloseEditBudgetBtn{{ budget_id }}">Save</button>
        </div>
      </div>
    </form>
  </div>
</div>


<!-- Edit Allocation Modal -->
{% for ba in budget_allocations.allocations %}
{% set allocation_category_id = ba.category_id %}
{% set allocation_category_name = ba.category_name %}
{% set allocation_allocated_amount = ba.allocated_amount %}
<div class="p-modal" id="pEditAllocationModal{{ allocation_category_id }}">
  <div class="p-modal-content">
    <form class="p-category-form" method="POST", action="/dashboard/allocations/{{ budget_details.id }}/edit">
      <a href="#" id="pEditAllocationClose{{ allocation_category_id }}" class="p-close"><i class="fa fa-close"></i></a>
      <h2 class="p-modal-limit-name">Edit Allocation</h2>
      <div class="p-modal-form-content">
        <input type="hidden" name="category_id" value="{{ allocation_category_id }}" required>
        <label>Category Name</label>
        <input type="text" value="{{ allocation_category_name }}" readonly>
        <label>Allocation Amount</label>
        <input type="number" name="allocated_amount" value="{{ allocation_allocated_amount }}" required>
        <button type="submit" class="p-modal-btn" id="pcloseEditAllocationBtn{{ allocation_category_id }}">Save</button>
      </div>
    </form>
  </div>
</div>
{% endfor %}

<!-- Alert & Confirm (single) -->
<div id="pAlert" class="p-alert">
  <div class="p-alert-content">
    <h3 id="pAlertTitle">Alert</h3>
    <p id="pAlertMessage"></p>
    <div class="p-alert-footer">
      <button id="pAlertOk" class="p-btn">OK</button>
    </div>
  </div>
</div>

<div id="pConfirm" class="p-confirm">
  <div class="p-confirm-content">
    <h3 id="pConfirmTitle">Confirm Action</h3>
    <p id="pConfirmMessage"></p>
    <div class="p-confirm-footer">
      <button id="pConfirmOk" class="p-btn p-btn-primary">OK</button>
      <button id="pConfirmCancel" class="p-btn p-btn-secondary">Cancel</button>
    </div>
  </div>
</div>
{% endblock %}