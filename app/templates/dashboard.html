{% extends "base.html" %}
{% block content %}
{# #pDetailCards { display: none; }#}

{# Security question warning (auto-dismiss after 20s) #}
{% if user.security_answer is none or user.security_answer == '' %}
<div class="p-alert-warning" role="alert" id="securityWarning" style="margin: .8rem 0; padding: .75rem 1rem; border-radius:.5rem; background:var(--warning); color:var(--bg-dark); box-shadow:var(--shadow);">
  <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
  <strong style="margin-left:.5rem">Important:</strong>
  <span style="margin-left:.5rem">Please set your <em>Security Question</em> from your Profile (☰ → Account → Profile) to help protect your account and enable password recovery.</span>
  <button id="closeSecurityWarning" style="float:right;background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--bg-dark)">×</button>
</div>
{% endif %}

{# Generic error alert (server-provided) #}
{% if error %}
<div class="p-alert-error" role="alert" style="margin: .5rem 0; padding: .6rem 1rem; border-radius:.4rem; background:var(--danger); color:var(--bg-light); box-shadow:var(--shadow);">
  <i class="fa fa-exclamation-circle"></i>
  <span style="margin-left:.5rem">{{ error }}</span>
</div>
{% endif %}

<!-- Title + toggles -->
<div class="p-title-card">
  <h1>{{ current_month }}'s Budget</h1>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.4rem;">
    <div>
      <strong>Welcome, {{ user.first_name }} {{ user.last_name }}</strong>
    </div>
    <div style="display:flex; gap:.5rem; align-items:center;">
      <button id="toggleVisibility" class="p-actions-btns" title="Hide/Show sensitive values"><i id="eyeIcon" class="fa fa-eye"></i></button>
     <!-- <button id="toggleCompact" class="p-actions-btns" title="Toggle Compact View"><i id="toggleCompactIcon" class="fa fa-list"></i></button> -->
    </div>
  </div>
</div>

<!-- Summary & Add Category -->
<section>
  <div class="p-summary-cards">
    <div class="p-summary-card">
      <h4>Total Limit</h4>
      <h2 class="p-summary-value sensitive" data-value="{{ categories_with_stats | sum(attribute='limit_amount') }}">{{ categories_with_stats | sum(attribute='limit_amount') }}</h2>
    </div>
    <div class="p-summary-card">
      <h4>Total Balance</h4>
      <h2 class="p-summary-value sensitive {% if categories_with_stats | sum(attribute='balance') < 0 %} p-negative {% endif %}" data-value="{{ categories_with_stats | sum(attribute='balance') }}">
        {{ categories_with_stats | sum(attribute='balance') }}
      </h2>
    </div>
  </div>
</section>
  <div class="p-add-category">
      <button class="p-button-info" id="launchAddCategory" onclick="generateModal('pCategoryModal','pCategoryClose','closeCategoryModalBtn')">+ Add New Category</button>
    </div>
<section>
</section>

<!-- DESKTOP: table view -->
<div id="tableView" class="table-responsive">
  <table id="categoriesTable" class="p-table" style="width:100%; border-collapse:collapse;">
    <thead>
      <tr style="text-align:left; border-bottom:1px solid var(--border);">
        <th style="padding:.6rem">Category</th>
        <th style="padding:.6rem">Limit</th>
        <th style="padding:.6rem">Expenses</th>
        <th style="padding:.6rem">Balance</th>
        <th style="padding:.6rem">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for cat in categories_with_stats %}
      <tr style="border-bottom:1px dashed var(--border);">
        <td style="padding:.6rem; font-weight:500;" data-label="Category">{{ cat.name }}</td>
        <td style="padding:.6rem;" data-label="Limit"><span class="sensitive" data-value="{{ cat.limit_amount }}">{{ cat.limit_amount }}</span></td>
        <td style="padding:.6rem;" data-label="Expenses">
          <a href="#" class="p-expense-amount {% if cat.expense_count == 0 %} p-empty-exp {% endif %}" onclick="generateModal('expensesModal{{ cat.id }}','expensesClose{{ cat.id }}','')">
            {{ cat.expense_count }}
          </a>
        </td>
        <td style="padding:.6rem;" data-label="Balance">
          <span class="sensitive {% if cat.balance < 0 %} p-negative {% endif %}" data-value="{{ cat.balance }}">
            {% if cat.balance < 0 %} Over by {{ -cat.balance }} {% else %} Remaining {{ cat.balance }} {% endif %}
          </span>
        </td>
        <td style="padding:.6rem;" data-label="Actions">
          <div style="display:flex; gap:.4rem; flex-wrap:wrap;">
            <form method="POST" action="/dashboard/expenses" onsubmit="return confirmSubmit(this, 'Add Quick expense of {{ cat.limit_amount }} to {{ cat.name }}?')">
              <input type="hidden" name="category_id" value="{{ cat.id }}">
              <input type="hidden" name="amount" value="{{ cat.limit_amount }}">
              <input type="hidden" name="description" value="Quick Expense">
              <input type="hidden" name="month" value="{{ now }}">
              <button class="p-actions-btns" type="submit" title="Quick Expense"><i class="fa fa-bolt"></i></button>
            </form>

            <button class="p-actions-btns" title="Add Expense" onclick="generateModal('addExpenseModal{{ cat.id }}','addExpenseClose{{ cat.id }}','')"><i class="fa fa-plus"></i></button>

            <button class="p-actions-btns" title="Edit Category" onclick="generateModal('editCategoryModal{{ cat.id }}','editCategoryClose{{ cat.id }}','')"><i class="fa fa-pencil"></i></button>

            <form method="POST" action="/dashboard/categories/{{ cat.id }}/delete" onsubmit="return confirmSubmit(this, 'Delete category {{ cat.name }}?')">
              <button class="p-actions-btns" type="submit" title="Delete Category"><i class="fa fa-trash"></i></button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- COMPACT -->
<div id="pDetailCards" class="p-detail-cards">
  {% for cat in categories_with_stats | sort(attribute='name')%}
  <div class="p-detail-card">
    <div class="p-category-limit">
      <p class="p-category-limit-name">{{ cat.name }}</p>
      <p class="p-category-limit-amount sensitive" data-value="{{ cat.limit_amount }}">{{ cat.limit_amount }}</p>
    </div>

    <div class="p-expense-container">
      <p class="p-expense-amount-name">Expenses</p>
      <a class="{% if cat.expense_count <= 0 %} p-empty-exp {% else %} p-expense-amount {% endif %}"
        href="#" onclick="generateModal('expensesModal{{ cat.id }}','expensesClose{{ cat.id }}','')">
        {{ cat.expense_count }}
      </a>
    </div>

    <div class="p-balance_and_buttons">
      <div class="p-remaining-container">
        <p class="p-remaining-caption">{% if cat.balance < 0 %} Over by {% else %}Remaining{% endif %}</p>
        <h4 class="p-remaining-amount sensitive {% if cat.balance <= 0 %} p-negative {% else %} p-positive {% endif %}" data-value="{{ cat.balance }}">
            {% if cat.balance < 0 %}{{ -cat.balance }}{% else %}{{ cat.balance }}{% endif %}
        </h4>
      </div>
  
      <div class="p-actions-container">
        <form method="POST" action="/dashboard/expenses"
              onsubmit="return confirmSubmit(this, 'Add Quick expense of {{ cat.limit_amount }} to {{ cat.name }}?')">
          <input type="hidden" name="category_id" value="{{ cat.id }}">
          <input type="hidden" name="amount" value="{{ cat.limit_amount }}">
          <input type="hidden" name="description" value="Quick Expense">
          <input type="hidden" name="month" value="{{ now }}">
          <button class="p-actions-btns-tertiary" type="submit" title="Quick Expense">
            <i class="fa fa-bolt"></i>
          </button>
        </form>
  
        <!-- Add Expense: primary -->
        <button class="p-actions-btns-primary" title="Add Expense"
                onclick="generateModal('addExpenseModal{{ cat.id }}','addExpenseClose{{ cat.id }}','')">
          <i class="fa fa-plus"></i>
        </button>
  
        <!-- Edit Category: secondary -->
        <button class="p-actions-btns-warning" title="Edit Category"
                onclick="generateModal('editCategoryModal{{ cat.id }}','editCategoryClose{{ cat.id }}','')">
          <i class="fa fa-pencil"></i>
        </button>
  
        <!-- Delete Category: danger -->
        <form method="POST" action="/dashboard/categories/{{ cat.id }}/delete"
              onsubmit="return confirmSubmit(this, 'Delete category {{ cat.name }}?')">
          <button class="p-actions-btns-danger" type="submit" title="Delete">
            <i class="fa fa-trash"></i>
          </button>
        </form>
      </div>
    </div>

  </div>
  {% endfor %}
</div>

{# ---------- Modals (single + per category) ---------- #}

<!-- Add Category modal -->
<div class="p-modal" id="pCategoryModal">
  <div class="p-modal-content">
    <form method="POST" action="/dashboard/categories">
      <a href="#" id="pCategoryClose" class="p-close"><i class="fa fa-close"></i></a>
      <h2 class="p-add-category-title">New Category</h2>
      <div class="p-modal-details">
        <label for="name">Name</label>
        <input name="name" placeholder="Enter Category Name (No Spaces Allowed)" maxlength="16" pattern="^[^ ]+$" title="Only letters, numbers, underscores, or hyphens allowed (no spaces or &)" required>
        <label for="limit_amount">Limit</label>
        <input name="limit_amount" type="number" placeholder="Enter Category Limit" required>
        <button type="submit" class="p-modal-btn" id="closeCategoryModalBtn">Add Category</button>
      </div>
    </form>
  </div>
</div>

<!-- Per-category modals -->
{% for cat in categories_with_stats %}
  <!-- Expenses list modal -->
  <div class="p-modal" id="expensesModal{{ cat.id }}">
    <div class="p-modal-content">
      <a href="#" id="expensesClose{{ cat.id }}" class="p-close"><i class="fa fa-close"></i></a>
      <h2 style="text-align: center;">Expenses — {{ cat.name }}</h2>
      <div class="p-modal-body">
        {% if cat.expenses %}
          <ul style="list-style:none;padding:1.2em;margin:0;">
            {% for e in cat.expenses %}
            <li style="padding:.5rem 0; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; gap:1rem;">
              <div>
                <strong>{{ e.amount }}</strong> — {{ e.description or "(no desc)" }}
                <small style="color:var(--text-muted)"> ({{ e.month }})</small>
              </div>
              <div style="display:flex; gap:.8rem;">
                <button class="p-btn-warning" onclick="generateModal('editExpenseModal{{ e.id }}','editExpenseClose{{ e.id }}','')">Edit</button>
                <form method="POST" action="/dashboard/expenses/{{ e.id }}/delete" onsubmit="return confirmSubmit(this,'Delete expense?')">
                  <button class="p-btn-danger" type="submit">Delete</button>
                </form>
              </div>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="p-no-expense">No expenses for this month. Click the ➕ or ⚡️ button to add expenses</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Add Expense modal -->
  <div class="p-modal" id="addExpenseModal{{ cat.id }}">
    <div class="p-modal-content">
      <a href="#" id="addExpenseClose{{ cat.id }}" class="p-close"><i class="fa fa-close"></i></a>
      <h2>Add Expense to {{ cat.name }}</h2>
      <form method="POST" action="/dashboard/expenses">
        <div class="p-modal-details">
          <input type="hidden" name="category_id" value="{{ cat.id }}">
          <label>Amount</label>
          <input name="amount" type="number" placeholder="Enter Expense Amount" required>
          <label>Description</label>
          <input name="description" placeholder="Enter Expense Description (Optional)">
          <label>Month</label>
          <input name="month" placeholder="YYYY-MM" value="{{ now }}" disabled>
          <button type="submit" class="p-modal-btn" id="closeAddExpenseBtn{{ cat.id }}">Add Expense</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Category modal -->
  <div class="p-modal" id="editCategoryModal{{ cat.id }}">
    <div class="p-modal-content">
      <a href="#" id="editCategoryClose{{ cat.id }}" class="p-close"><i class="fa fa-close"></i></a>
      <h2>Edit Category</h2>
      <form method="POST" action="/dashboard/categories/{{ cat.id }}/edit">
        <div class="p-modal-details">
          <label>Name</label>
          <input name="name" value="{{ cat.name }}" maxlength="16" pattern="^[A-Za-z0-9_-]+$" title="Only letters, numbers, underscores, or hyphens allowed (no spaces or &)" required>
          <label>Limit</label>
          <input name="limit_amount" type="number" value="{{ cat.limit_amount }}" required>
          <button type="submit" class="p-modal-btn" id="closeEditCategoryBtn{{ cat.id }}">Save</button>
        </div>
      </form>
    </div>
  </div>

  {# Edit each expense of this category #}
  {% for e in cat.expenses %}
  <div class="p-modal" id="editExpenseModal{{ e.id }}">
    <div class="p-modal-content">
      <a href="#" id="editExpenseClose{{ e.id }}" class="p-close"><i class="fa fa-close"></i></a>
      <h2>Edit Expense</h2>
      <form method="POST" action="/dashboard/expenses/{{ e.id }}/edit">
        <div class="p-modal-details">
          <label>Amount</label>
          <input name="amount" type="number" value="{{ e.amount }}" required>
          <label>Description</label>
          <input name="description" value="{{ e.description }}">
          <label>Month (YYYY-MM)</label>
          <input name="month" value="{{ e.month }}" disabled>
          <label>Category</label>
          <select name="category_id" required>
            {% for c in categories_with_stats %}
            <option value="{{ c.id }}" {% if c.id == e.category_id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="p-modal-btn" id="closeEditExpenseBtn{{ e.id }}">Save</button>
        </div>
      </form>
    </div>
  </div>
  {% endfor %}
{% endfor %}

<!-- Alert & Confirm (single) -->
<div id="pAlert" class="p-alert">
  <div class="p-alert-content">
    <h3 id="pAlertTitle">Alert</h3>
    <p id="pAlertMessage"></p>
    <div class="p-alert-footer">
      <button id="pAlertOk" class="p-btn">OK</button>
    </div>
  </div>
</div>

<div id="pConfirm" class="p-confirm">
  <div class="p-confirm-content">
    <h3 id="pConfirmTitle">Confirm Action</h3>
    <p id="pConfirmMessage"></p>
    <div class="p-confirm-footer">
      <button id="pConfirmOk" class="p-btn">OK</button>
      <button id="pConfirmCancel" class="p-btn p-btn-secondary">Cancel</button>
    </div>
  </div>
</div>
{% endblock %}
