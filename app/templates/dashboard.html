{% extends "base.html" %}
{% block content %}

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

<h1 class="display-6">{{ current_month }}'s Budget</h1>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <strong>Welcome, {{ user.first_name }} {{ user.last_name }}</strong>
  </div>
  <div>
    <button id="toggleVisibility" class="btn btn-outline-secondary btn-sm me-2">
      <i class="bi bi-eye-fill"></i>
    </button>
    <button id="toggleCompact" class="btn btn-outline-primary btn-sm">
      <i id="toggleCompactIcon" class="bi bi-list-check"></i>
    </button>
  </div>
</div>

<!-- ‚úÖ Summary & Add Category -->
<div class="row mb-3">
  <div class="col-md-3 col-6">
    <div class="card text-center shadow-sm">
      <div class="card-body p-2">
        <h6 class="card-title mb-1">Total Limit</h6>
        <p class="card-text fw-bold sensitive">
          {{ categories_with_stats | sum(attribute='limit_amount') }}
        </p>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-6">
    <div class="card text-center shadow-sm">
      <div class="card-body p-2">
        <h6 class="card-title mb-1">Total Balance</h6>
        <p class="card-text fw-bold sensitive
          {% if categories_with_stats | sum(attribute='balance') < 0 %} text-danger {% else %} text-success {% endif %}">
          {{ categories_with_stats | sum(attribute='balance') }}
        </p>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-12 mt-2 mt-md-0">
    <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
      + Add New Category
    </button>
  </div>
</div>

<!-- ‚úÖ Categories Table -->
<div class="table-responsive">
  <table id="categoriesTable" class="table table-bordered table-striped align-middle">
    <thead>
      <tr>
        <th>Category</th>
        <th>Limit</th>
        <th>Expenses</th>
        <th>Balance</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for cat in categories_with_stats %}
      <tr class="d-block d-md-table-row mb-3 mb-md-0 border rounded shadow-sm">
        <td data-label="Category" class="fw-bold">{{ cat.name }}</td>
        <td data-label="Limit">
          <span class="sensitive">{{ cat.limit_amount }}</span>
        </td>
        <td data-label="Expenses">
          <a href="#" data-bs-toggle="modal" data-bs-target="#expensesModal{{ cat.id }}" 
             class="{% if cat.expense_count == 0 %} text-danger {% else %} text-primary {% endif %}">
            {{ cat.expense_count }}
          </a>
        </td>
        <td data-label="Balance" class="{% if cat.balance < 0 %} bg-danger text-white {% else %} bg-success text-white {% endif %}">
          {% if cat.balance < 0 %}
            Over by {{ -cat.balance }}
          {% else %}
            Remaining {{ cat.balance }}
          {% endif %}
        </td>
        <td data-label="Actions">
          <div class="d-flex flex-wrap gap-1 justify-content-start">
            <!-- ‚úÖ Quick Expense -->
            <form method="POST" action="/dashboard/expenses" class="flex-fill"
                  onsubmit="return confirm('Add quick expense of {{ cat.limit_amount }} to {{ cat.name }}?')">
              <input type="hidden" name="category_id" value="{{ cat.id }}">
              <input type="hidden" name="amount" value="{{ cat.limit_amount }}">
              <input type="hidden" name="description" value="Quick Expense">
              <input type="hidden" name="month" value="{{ now }}">
              <button class="btn btn-sm btn-outline-success w-30">‚ö° Quick</button>
            </form>

            <!-- Add expense -->
            <button class="btn btn-sm btn-outline-primary w-30 flex-fill" 
                    data-bs-toggle="modal" 
                    data-bs-target="#addExpenseModal{{ cat.id }}">
              + Expense
            </button>

            <!-- Edit category -->
            <button class="btn btn-sm btn-warning w-30 flex-fill" 
                    data-bs-toggle="modal" 
                    data-bs-target="#editCategoryModal{{ cat.id }}">
              ü™õ
            </button>

            <!-- Delete category -->
            <form method="POST" action="/dashboard/categories/{{ cat.id }}/delete" class="flex-fill">
              <button class="btn btn-sm btn-danger w-30" type="submit" onclick="return confirm('Delete category?')">
                üóëÔ∏è
              </button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ‚úÖ Compact View (hidden by default, with buttons) -->
<div id="compactView" class="row g-2 d-none">
  {% for cat in categories_with_stats %}
  <div class="col-12 col-md-6">
    <div class="card shadow-sm border-left">
      <div class="card-body d-flex justify-content-between align-items-center">
        <span class="fw-bold">{{ cat.name }}</span>
        <div class="d-flex align-items-center gap-2">
          <span class="{% if cat.balance < 0 %} text-danger {% else %} text-success {% endif %} sensitive">
            {% if cat.balance < 0 %}
              Over by {{ -cat.balance }}
            {% else %}
              Remaining {{ cat.balance }}
            {% endif %}
          </span>
          <!-- Quick Expense -->
          <form method="POST" action="/dashboard/expenses" 
                onsubmit="return confirm('Add quick expense of {{ cat.limit_amount }} to {{ cat.name }}?')">
            <input type="hidden" name="category_id" value="{{ cat.id }}">
            <input type="hidden" name="amount" value="{{ cat.limit_amount }}">
            <input type="hidden" name="description" value="Quick Expense">
            <input type="hidden" name="month" value="{{ now }}">
            <button class="btn btn-sm btn-outline-success" title="Quick Expense">‚ö°</button>
          </form>
          <!-- Add Expense -->
          <button class="btn btn-sm btn-outline-primary" 
                  data-bs-toggle="modal" 
                  data-bs-target="#addExpenseModal{{ cat.id }}"
                  title="Add Expense">
            +
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- ‚úÖ Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="/dashboard/categories">
        <div class="modal-header">
          <h5 class="modal-title">Add Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label>Name</label>
            <input class="form-control" name="name" required>
          </div>
          <div class="mb-2">
            <label>Limit</label>
            <input class="form-control" name="limit_amount" type="number" step="0.01">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Add Category</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ‚úÖ Expense/Category Modals -->
{% for cat in categories_with_stats %}

  <!-- Expenses Modal -->
  <div class="modal fade" id="expensesModal{{ cat.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Expenses ‚Äî {{ cat.name }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          {% if cat.expenses %}
          <ul class="list-group">
            {% for e in cat.expenses %}
            <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-md-center">
              <div>
                <strong>{{ e.amount }}</strong> ‚Äî {{ e.description or "(no desc)" }}
                <small class="text-muted">({{ e.month }})</small>
              </div>
              <div class="mt-2 mt-md-0">
                <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editExpenseModal{{ e.id }}">Edit</button>
                <form method="POST" action="/dashboard/expenses/{{ e.id }}/delete" style="display:inline;">
                  <button class="btn btn-sm btn-danger" type="submit" onclick="return confirm('Delete expense?')">Delete</button>
                </form>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p>No expenses for this month.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Add Expense Modal -->
  <div class="modal fade" id="addExpenseModal{{ cat.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="/dashboard/expenses">
          <div class="modal-header">
            <h5 class="modal-title">Add Expense to {{ cat.name }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="category_id" value="{{ cat.id }}">
            <div class="mb-2">
              <label>Amount</label>
              <input class="form-control" name="amount" type="number" step="0.01" required>
            </div>
            <div class="mb-2">
              <label>Description</label>
              <input class="form-control" name="description">
            </div>
            <div class="mb-2">
              <label>Month</label>
              <input class="form-control" name="month" placeholder="YYYY-MM" value="{{ now }}">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" type="submit">Add Expense</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Category Modal -->
  <div class="modal fade" id="editCategoryModal{{ cat.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="/dashboard/categories/{{ cat.id }}/edit">
          <div class="modal-header">
            <h5 class="modal-title">Edit Category</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label>Name</label>
              <input class="form-control" name="name" value="{{ cat.name }}" required>
            </div>
            <div class="mb-2">
              <label>Limit</label>
              <input class="form-control" name="limit_amount" type="number" value="{{ cat.limit_amount }}">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Expense Modals -->
  {% for e in cat.expenses %}
  <div class="modal fade" id="editExpenseModal{{ e.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="/dashboard/expenses/{{ e.id }}/edit">
          <div class="modal-header">
            <h5 class="modal-title">Edit Expense</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label>Amount</label>
              <input class="form-control" name="amount" value="{{ e.amount }}" required>
            </div>
            <div class="mb-2">
              <label>Description</label>
              <input class="form-control" name="description" value="{{ e.description }}">
            </div>
            <div class="mb-2">
              <label>Month (YYYY-MM)</label>
              <input class="form-control" name="month" value="{{ e.month }}">
            </div>
            <div class="mb-2">
              <label>Category</label>
              <select class="form-control" name="category_id" required>
                {% for c in categories_with_stats %}
                <option value="{{ c.id }}" {% if c.id == e.category_id %}selected{% endif %}>
                  {{ c.name }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endfor %}
{% endfor %}

<style>
/* Mobile-friendly stacked table */
@media (max-width: 768px) {
  table thead { display: none; }
  table tbody tr {
    display: block;
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
    border-radius: .5rem;
    padding: .5rem;
  }
  table tbody td {
    display: flex;
    justify-content: space-between;
    padding: .5rem .75rem;
    border: none !important;
    border-bottom: 1px solid #dee2e6;
  }
  table tbody td:last-child { border-bottom: none; }
  table tbody td::before {
    content: attr(data-label);
    font-weight: 600;
    margin-right: .5rem;
    color: #555;
  }
}

/* Compact view styling */
#compactView .card {
  border-left: 5px solid #29e57aff;
}
#compactView .card .fw-bold {
  font-size: 1rem;
}
#compactView .btn { padding: 0.25rem 0.5rem; min-width: 34px; }

/* Active button state */
#toggleCompact.active {
  background-color: #0d6efd;
  color: #fff;
  border-color: #0d6efd;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const toggleCompact = document.getElementById("toggleCompact");
  const tableWrapper = document.querySelector(".table-responsive");
  const compactView = document.getElementById("compactView");
  const icon = document.getElementById("toggleCompactIcon");

  let compactMode = false;

  toggleCompact.addEventListener("click", function () {
    compactMode = !compactMode;

    if (compactMode) {
      tableWrapper.classList.add("d-none");
      compactView.classList.remove("d-none");
      toggleCompact.classList.add("btn-success");
    } else {
      tableWrapper.classList.remove("d-none");
      compactView.classList.add("d-none");
      toggleCompact.classList.remove("btn-success");
    }

    // Toggle icon
    icon.classList.toggle("bi-list-check");
    icon.classList.toggle("bi-list-columns");

    // Toggle active button styling
    toggleCompact.classList.toggle("active");
  });
});
</script>

{% endblock %}
